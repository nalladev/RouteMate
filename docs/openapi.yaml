openapi: 3.0.0
info:
  title: RouteMate API
  description: |
    API for RouteMate ride-sharing application
    
    ## Map & Location Services
    
    RouteMate uses **free and open-source alternatives** instead of Google APIs:
    
    - **Map Display**: React Native Maps (uses native maps - Google Maps on Android, Apple Maps on iOS)
      - No API key required for basic map display
      
    - **Place Search/Geocoding**: Nominatim (OpenStreetMap)
      - Endpoint: https://nominatim.openstreetmap.org/search
      - Free to use with proper attribution
      - Usage limit: Max 1 request per second
      
    - **Routing/Directions**: OSRM (Open Source Routing Machine)
      - Endpoint: https://router.project-osrm.org/route/v1/driving
      - Completely free and open-source
      - No API key required
      
    This approach eliminates the need for Google Maps API billing while providing full functionality.
  version: 1.0.0
servers:
  - url: http://localhost:8081
    description: Local development server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  
  schemas:
    Location:
      type: object
      properties:
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
      required:
        - lat
        - lng
    
    UserState:
      type: string
      enum:
        - driving
        - riding
        - idle

    KycStatus:
      type: string
      enum:
        - not_started
        - session_created
        - submitted
        - under_review
        - approved
        - rejected
        - failed

    KycData:
      type: object
      properties:
        sessionId:
          type: string
        status:
          $ref: '#/components/schemas/KycStatus'
        createdAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        reviewedAt:
          type: string
          format: date-time
        verifiedAt:
          type: string
          format: date-time
        age:
          type: number
        gender:
          type: string
        portraitImage:
          type: string
        address:
          type: string
    
    User:
      type: object
      properties:
        Id:
          type: string
        Name:
          type: string
        Mobile:
          type: string
        state:
          $ref: '#/components/schemas/UserState'
        LastLocation:
          $ref: '#/components/schemas/Location'
        Destination:
          $ref: '#/components/schemas/Location'
        WalletBalance:
          type: number
          format: double
          description: Internal wallet balance in INR
        UpiId:
          type: string
          description: User's UPI ID for payouts
        VehicleType:
          type: string
          enum:
            - Sedan
            - SUV
            - Hatchback
            - Bike
            - Auto
            - Van
            - Other
          description: Driver vehicle type shown to passengers
        KycStatus:
          $ref: '#/components/schemas/KycStatus'
        KycData:
          $ref: '#/components/schemas/KycData'
        IsKycVerified:
          type: boolean
        DriverRatingAverage:
          type: number
          format: double
          description: Driver's aggregate average rating (1.0 to 5.0)
        DriverRatingCount:
          type: integer
          description: Total number of received driver ratings
        PassengerRewardPoints:
          type: integer
          description: Reward points earned from completed rides as passenger
        DriverRewardPoints:
          type: integer
          description: Reward points earned from 5-star ratings as driver
        ActiveCommunityId:
          type: string
          nullable: true
          description: Active community mode selection. When set, discovery and requests are scoped to that community.
    
    RideConnectionState:
      type: string
      enum:
        - requested
        - accepted
        - rejected
        - picked_up
        - completed

    VehicleConfirmationState:
      type: string
      enum:
        - pending
        - confirmed
        - mismatch
    
    PaymentStatus:
      type: string
      enum:
        - pending
        - success
        - failed
    
    TransactionType:
      type: string
      enum:
        - topup
        - payout
        - ride_payment
        - ride_earning

    RewardRole:
      type: string
      enum:
        - passenger
        - driver

    RewardVoucher:
      type: object
      properties:
        id:
          type: string
        role:
          $ref: '#/components/schemas/RewardRole'
        title:
          type: string
        description:
          type: string
        pointsCost:
          type: integer

    RewardRedemption:
      type: object
      properties:
        Id:
          type: string
        UserId:
          type: string
        VoucherId:
          type: string
        VoucherTitle:
          type: string
        Role:
          $ref: '#/components/schemas/RewardRole'
        PointsCost:
          type: integer
        Status:
          type: string
          enum:
            - redeemed
        CreatedAt:
          type: string
          format: date-time

    Community:
      type: object
      properties:
        Id:
          type: string
        Name:
          type: string
        AdminId:
          type: string
        participantCount:
          type: integer
        isAdmin:
          type: boolean
        isActive:
          type: boolean
        CreatedAt:
          type: string
          format: date-time

    CommunityMember:
      type: object
      properties:
        Id:
          type: string
        Name:
          type: string
        Mobile:
          type: string
        isAdmin:
          type: boolean
    
    RideConnection:
      type: object
      properties:
        Id:
          type: string
        PassengerId:
          type: string
        DriverId:
          type: string
        PickupLocation:
          $ref: '#/components/schemas/Location'
        Destination:
          $ref: '#/components/schemas/Location'
        Distance:
          type: number
          format: double
        Fare:
          type: number
          format: double
        RideTotalTime:
          type: number
          format: double
        OtpCode:
          type: string
        RequestedVehicleType:
          type: string
          description: Vehicle type selected by driver at request time
        PassengerVehicleConfirmation:
          $ref: '#/components/schemas/VehicleConfirmationState'
        PassengerVehicleConfirmedAt:
          type: string
          format: date-time
        State:
          $ref: '#/components/schemas/RideConnectionState'
        PaymentStatus:
          $ref: '#/components/schemas/PaymentStatus'
        DriverRating:
          type: integer
          minimum: 1
          maximum: 5
          description: Passenger's rating for this ride's driver
        DriverRatedAt:
          type: string
          format: date-time
        ShareToken:
          type: string
          description: Token used to build public live ride sharing link
        ShareCreatedAt:
          type: string
          format: date-time
        CommunityId:
          type: string
          nullable: true
          description: Community scoping for this request/ride when community mode is used
        CreatedAt:
          type: string
          format: date-time
        ExpiresAt:
          type: string
          format: date-time

    RideShareDetails:
      type: object
      properties:
        connection:
          type: object
          properties:
            Id:
              type: string
            State:
              $ref: '#/components/schemas/RideConnectionState'
            PickupLocation:
              $ref: '#/components/schemas/Location'
            Destination:
              $ref: '#/components/schemas/Location'
            Distance:
              type: number
              format: double
            Fare:
              type: number
              format: double
            CreatedAt:
              type: string
              format: date-time
              nullable: true
            RideTotalTime:
              type: number
              format: double
              nullable: true
        driver:
          type: object
          properties:
            name:
              type: string
            vehicleType:
              type: string
              nullable: true
            ratingAverage:
              type: number
              format: double
              nullable: true
            ratingCount:
              type: integer
            lastLocation:
              allOf:
                - $ref: '#/components/schemas/Location'
              nullable: true
        passenger:
          type: object
          properties:
            name:
              type: string
            lastLocation:
              allOf:
                - $ref: '#/components/schemas/Location'
              nullable: true
        sharedAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
    
    Transaction:
      type: object
      properties:
        Id:
          type: string
        UserId:
          type: string
        Type:
          $ref: '#/components/schemas/TransactionType'
        Amount:
          type: number
          format: double
        BalanceBefore:
          type: number
          format: double
        BalanceAfter:
          type: number
          format: double
        Status:
          $ref: '#/components/schemas/PaymentStatus'
        Description:
          type: string
        RazorpayOrderId:
          type: string
        RazorpayPaymentId:
          type: string
        RazorpayPayoutId:
          type: string
        CreatedAt:
          type: string
          format: date-time
    
    MarkerData:
      type: object
      properties:
        userId:
          type: string
        name:
          type: string
        rating:
          type: number
          format: double
        vehicle:
          type: string
        lastLocation:
          $ref: '#/components/schemas/Location'
        destination:
          $ref: '#/components/schemas/Location'
    
    Error:
      type: object
      properties:
        error:
          type: string

paths:
  /api/auth/login:
    post:
      summary: Password-based login
      description: Authenticate user with mobile and password
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mobile:
                  type: string
                password:
                  type: string
              required:
                - mobile
                - password
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/auth/otp-login:
    post:
      summary: OTP-based login
      description: Login via phone.email OTP token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                otpToken:
                  type: string
              required:
                - otpToken
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid OTP token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/auth/signup:
    post:
      summary: Create new account
      description: Register new user after OTP verification
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                otpToken:
                  type: string
                password:
                  type: string
              required:
                - otpToken
                - password
      responses:
        '200':
          description: Account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid OTP token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/auth/logout:
    post:
      summary: Logout user
      description: Invalidate user session
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully logged out
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/user/me:
    get:
      summary: Get current user profile
      description: Fetch logged-in user profile information
      tags:
        - User
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/user/state:
    post:
      summary: Update user state
      description: Update user activity state and destination. Switching to `idle` is blocked while the user has any connected ride in `accepted` or `picked_up` state.
      tags:
        - User
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  $ref: '#/components/schemas/UserState'
                destination:
                  $ref: '#/components/schemas/Location'
              required:
                - state
      responses:
        '200':
          description: State updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - cannot switch to idle while a connected ride is in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/user/location:
    post:
      summary: Update user location
      description: Update user's current GPS location
      tags:
        - User
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                lat:
                  type: number
                  format: double
                lng:
                  type: number
                  format: double
              required:
                - lat
                - lng
      responses:
        '200':
          description: Location updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/user/vehicle:
    post:
      summary: Update user vehicle type
      description: Set or update driver vehicle type used for rider discovery and ride confirmation
      tags:
        - User
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                vehicleType:
                  type: string
                  enum:
                    - Sedan
                    - SUV
                    - Hatchback
                    - Bike
                    - Auto
                    - Van
                    - Other
              required:
                - vehicleType
      responses:
        '200':
          description: Vehicle type updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  vehicleType:
                    type: string
        '400':
          description: Invalid vehicle type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/match/markers:
    get:
      summary: Get filtered markers
      description: Returns filtered nearby drivers or passengers based on role and flexible route compatibility (route corridor and endpoint proximity, not exact same path). If user has `ActiveCommunityId`, results are additionally scoped to that community.
      tags:
        - Discovery
      security:
        - bearerAuth: []
      parameters:
        - name: role
          in: query
          required: true
          schema:
            type: string
            enum:
              - driver
              - passenger
        - name: lat
          in: query
          required: true
          schema:
            type: number
            format: double
        - name: lng
          in: query
          required: true
          schema:
            type: number
            format: double
      responses:
        '200':
          description: List of filtered markers
          content:
            application/json:
              schema:
                type: object
                properties:
                  markers:
                    type: array
                    items:
                      $ref: '#/components/schemas/MarkerData'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/request:
    post:
      summary: Request a ride
      description: Passenger requests ride from a driver. Validates passenger has sufficient balance and stores driver's current vehicle type for later confirmation. If either side has community mode enabled, both users must belong to the same community.
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driverId:
                  type: string
                pickupLocation:
                  $ref: '#/components/schemas/Location'
                destination:
                  $ref: '#/components/schemas/Location'
              required:
                - driverId
                - pickupLocation
                - destination
      responses:
        '201':
          description: Ride requested successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                  expiresAt:
                    type: string
                    format: date-time
        '400':
          description: Bad request or insufficient balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Driver not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/request/cancel:
    post:
      summary: Cancel ride request
      description: Cancel pending ride request
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requestId:
                  type: string
              required:
                - requestId
      responses:
        '200':
          description: Request cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/requests:
    get:
      summary: Get pending requests
      description: Driver fetches pending ride requests
      tags:
        - Rides
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of pending requests
          content:
            application/json:
              schema:
                type: object
                properties:
                  requests:
                    type: array
                    items:
                      $ref: '#/components/schemas/RideConnection'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/request/respond:
    post:
      summary: Respond to ride request
      description: Driver accepts or rejects ride request
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requestId:
                  type: string
                action:
                  type: string
                  enum:
                    - accepted
                    - rejected
              required:
                - requestId
                - action
      responses:
        '200':
          description: Response recorded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  connection:
                    $ref: '#/components/schemas/RideConnection'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/connection/verify-otp:
    post:
      summary: Verify pickup OTP
      description: Driver verifies passenger OTP at pickup. Requires passenger to confirm expected vehicle first.
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                connectionId:
                  type: string
                otp:
                  type: string
              required:
                - connectionId
                - otp
      responses:
        '200':
          description: OTP verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Bad request or invalid OTP
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rides/connection/confirm-vehicle:
    post:
      summary: Passenger confirms expected vehicle
      description: Passenger confirms whether arriving vehicle matches the one shown at request time.
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                connectionId:
                  type: string
                isSameVehicle:
                  type: boolean
              required:
                - connectionId
                - isSameVehicle
      responses:
        '200':
          description: Vehicle confirmation captured
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  confirmation:
                    $ref: '#/components/schemas/VehicleConfirmationState'
        '400':
          description: Invalid request or connection state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/connection/complete:
    post:
      summary: Complete ride
      description: Marks ride as completed and processes payment atomically. Deducts fare from passenger balance and credits driver balance. Creates transaction records and awards passenger reward points.
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                connectionId:
                  type: string
              required:
                - connectionId
      responses:
        '200':
          description: Ride completed and payment processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  paymentStatus:
                    type: string
                  fare:
                    type: number
                    format: double
                  passengerBalance:
                    type: number
                    format: double
                  driverBalance:
                    type: number
                    format: double
                  passengerPointsAwarded:
                    type: integer
                  passengerRewardPoints:
                    type: integer
        '400':
          description: Bad request or insufficient balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Payment processing failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rides/connection/rate:
    post:
      summary: Rate driver after ride
      description: Passenger submits a 1-5 star rating for the driver on a completed ride. Updates ride and driver aggregate rating, and awards driver reward points on 5-star ratings.
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                connectionId:
                  type: string
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
              required:
                - connectionId
                - rating
      responses:
        '200':
          description: Rating submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rating:
                    type: integer
                  driverRatingAverage:
                    type: number
                    format: double
                  driverRatingCount:
                    type: integer
                  driverPointsAwarded:
                    type: integer
                  driverRewardPoints:
                    type: integer
        '400':
          description: Invalid request, invalid rating, ride not completed, or already rated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rides/share/create:
    post:
      summary: Create or fetch public ride share link
      description: Creates (or returns existing) live ride tracking link for a ride participant.
      tags:
        - Rides
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                connectionId:
                  type: string
              required:
                - connectionId
      responses:
        '200':
          description: Share link generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  shareToken:
                    type: string
                  shareUrl:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rides/share/details:
    get:
      summary: Get public live ride details by token
      description: Public endpoint used by browser share page to display live ride status, route points, and participant details.
      tags:
        - Rides
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Shared ride details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RideShareDetails'
        '400':
          description: Token is missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Shared ride not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Shared ride no longer available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/connections:
    get:
      summary: Get active connections
      description: Returns active ride connections for current user
      tags:
        - Rides
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of active connections
          content:
            application/json:
              schema:
                type: object
                properties:
                  connections:
                    type: array
                    items:
                      $ref: '#/components/schemas/RideConnection'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/rides/history:
    get:
      summary: Get ride history
      description: Returns completed rides for user
      tags:
        - Rides
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of completed rides
          content:
            application/json:
              schema:
                type: object
                properties:
                  rides:
                    type: array
                    items:
                      $ref: '#/components/schemas/RideConnection'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities:
    get:
      summary: List my communities
      description: Returns all communities where the authenticated user is a participant and indicates active community mode.
      tags:
        - Community
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Community list
          content:
            application/json:
              schema:
                type: object
                properties:
                  communities:
                    type: array
                    items:
                      $ref: '#/components/schemas/Community'
                  activeCommunityId:
                    type: string
                    nullable: true
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities/create:
    post:
      summary: Create community
      description: Creates a new community with the authenticated user as admin and first participant.
      tags:
        - Community
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 3
                  maxLength: 64
              required:
                - name
      responses:
        '201':
          description: Community created
          content:
            application/json:
              schema:
                type: object
                properties:
                  community:
                    $ref: '#/components/schemas/Community'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities/select:
    post:
      summary: Enable or disable community mode
      description: Sets active community mode for discovery/request filtering. Pass null to disable community mode.
      tags:
        - Community
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                communityId:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Updated active community mode
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  activeCommunityId:
                    type: string
                    nullable: true
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: User is not a community member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Community not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities/{communityId}/members:
    get:
      summary: Get community members (admin only)
      description: Returns member overview for a specific community. Only the community admin can access this endpoint.
      tags:
        - Community
      security:
        - bearerAuth: []
      parameters:
        - name: communityId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member list
          content:
            application/json:
              schema:
                type: object
                properties:
                  community:
                    type: object
                    properties:
                      Id:
                        type: string
                      Name:
                        type: string
                      AdminId:
                        type: string
                  members:
                    type: array
                    items:
                      $ref: '#/components/schemas/CommunityMember'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Only community admin can view members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Community not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities/{communityId}/members/remove:
    post:
      summary: Remove community member (admin only)
      description: Removes a participant from a community. Admin cannot remove themselves.
      tags:
        - Community
      security:
        - bearerAuth: []
      parameters:
        - name: communityId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                memberId:
                  type: string
              required:
                - memberId
      responses:
        '200':
          description: Member removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid request (e.g., removing admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Only community admin can remove members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Community/member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities/invite/create:
    post:
      summary: Create community invite link
      description: Admin creates an expiring invite link for a community.
      tags:
        - Community
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                communityId:
                  type: string
                expiresInHours:
                  type: integer
                  enum:
                    - 1
                    - 6
                    - 24
                    - 72
                    - 168
              required:
                - communityId
                - expiresInHours
      responses:
        '200':
          description: Invite link created
          content:
            application/json:
              schema:
                type: object
                properties:
                  communityId:
                    type: string
                  expiresInHours:
                    type: integer
                  expiresAt:
                    type: string
                    format: date-time
                  inviteToken:
                    type: string
                  inviteUrl:
                    type: string
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Only admin can create links
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Community not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/communities/invite/accept:
    post:
      summary: Accept community invite
      description: Join a community by invite token and activate community mode for that community.
      tags:
        - Community
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
              required:
                - token
      responses:
        '200':
          description: Invite accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  alreadyMember:
                    type: boolean
                  community:
                    type: object
                    properties:
                      Id:
                        type: string
                      Name:
                        type: string
                      AdminId:
                        type: string
                  activeCommunityId:
                    type: string
        '400':
          description: Invite expired/revoked/invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Invite/community not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rewards/list:
    get:
      summary: Get rewards points, vouchers, and redemptions
      description: Returns passenger and driver reward points, dummy voucher catalog, and recent redemptions.
      tags:
        - Rewards
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Rewards payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  points:
                    type: object
                    properties:
                      passenger:
                        type: integer
                      driver:
                        type: integer
                  vouchers:
                    type: object
                    properties:
                      passenger:
                        type: array
                        items:
                          $ref: '#/components/schemas/RewardVoucher'
                      driver:
                        type: array
                        items:
                          $ref: '#/components/schemas/RewardVoucher'
                  redemptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/RewardRedemption'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rewards/redeem:
    post:
      summary: Redeem reward voucher
      description: Redeems a voucher by deducting points from the selected role wallet if enough points are available.
      tags:
        - Rewards
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  $ref: '#/components/schemas/RewardRole'
                voucherId:
                  type: string
              required:
                - role
                - voucherId
      responses:
        '200':
          description: Voucher redeemed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  role:
                    $ref: '#/components/schemas/RewardRole'
                  voucher:
                    $ref: '#/components/schemas/RewardVoucher'
                  remainingPoints:
                    type: integer
        '400':
          description: Invalid request or insufficient points
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Voucher or user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/balance:
    get:
      summary: Get wallet balance
      description: Fetch wallet balance in INR
      tags:
        - Wallet
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Wallet information
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                    format: double
                    description: Balance in INR
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/topup/create-order:
    post:
      summary: Create Razorpay order for wallet top-up
      description: Creates a Razorpay order for adding funds to wallet
      tags:
        - Wallet
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: double
                  description: Amount in INR (min 100, max 10000)
              required:
                - amount
      responses:
        '200':
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  orderId:
                    type: string
                  amount:
                    type: number
                  currency:
                    type: string
                  razorpayKeyId:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/topup/verify:
    post:
      summary: Verify Razorpay payment
      description: Verifies Razorpay payment signature and credits wallet
      tags:
        - Wallet
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                razorpayOrderId:
                  type: string
                razorpayPaymentId:
                  type: string
                razorpaySignature:
                  type: string
              required:
                - razorpayOrderId
                - razorpayPaymentId
                - razorpaySignature
      responses:
        '200':
          description: Payment verified and wallet updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  balance:
                    type: number
                    format: double
        '400':
          description: Invalid signature or payment verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/topup/webhook:
    post:
      summary: Razorpay webhook handler
      description: Handles Razorpay payment notifications (no authentication required)
      tags:
        - Wallet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Razorpay webhook payload
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
        '400':
          description: Invalid webhook signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/payout/request:
    post:
      summary: Request payout to UPI
      description: Request withdrawal of funds to user's UPI ID
      tags:
        - Wallet
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: double
                  description: Amount to withdraw in INR
                upiId:
                  type: string
                  description: UPI ID (optional if already stored)
              required:
                - amount
      responses:
        '200':
          description: Payout initiated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  payoutId:
                    type: string
                  status:
                    type: string
        '400':
          description: Bad request or insufficient balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/transactions:
    get:
      summary: Get transaction history
      description: Returns wallet transaction history for the user
      tags:
        - Wallet
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Transaction history
          content:
            application/json:
              schema:
                type: object
                properties:
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/wallet/upi/update:
    post:
      summary: Update UPI ID
      description: Update or set user's UPI ID for payouts
      tags:
        - Wallet
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                upiId:
                  type: string
                  description: UPI ID in format user@bank
              required:
                - upiId
      responses:
        '200':
          description: UPI ID updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  upiId:
                    type: string
        '400':
          description: Invalid UPI ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/kyc/create-session:
    post:
      summary: Create KYC Session
      description: Create a new Didit KYC verification session and bind it to the authenticated user
      tags:
        - KYC
      security:
        - bearerAuth: []
      responses:
        '200':
          description: KYC session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                  verificationUrl:
                    type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: KYC service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/kyc/verify:
    post:
      summary: Refresh KYC Status
      description: Fetch latest Didit session status for the authenticated user and update local KYC fields
      tags:
        - KYC
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sessionId:
                  type: string
                  description: Optional Didit session ID. If omitted, backend uses stored user KYC session ID.
      responses:
        '200':
          description: KYC status refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  verified:
                    type: boolean
                  status:
                    $ref: '#/components/schemas/KycStatus'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to fetch status from provider
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/kyc/webhook:
    post:
      summary: Didit KYC Webhook
      description: Receives asynchronous verification updates from Didit and updates user KYC status
      tags:
        - KYC
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid webhook signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

tags:
  - name: Authentication
    description: User authentication endpoints
  - name: User
    description: User profile and state management
  - name: Discovery
    description: Driver/passenger discovery and matching
  - name: Rides
    description: Ride request and connection management
  - name: Community
    description: Community management, invite links, and scoped discovery mode
  - name: Rewards
    description: Reward points and voucher redemption
  - name: Wallet
    description: Wallet and payment operations
  - name: KYC
    description: KYC verification operations
