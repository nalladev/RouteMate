name: Extract Keystore Fingerprint

on:
  push:
    branches:
      - development
  workflow_dispatch:

jobs:
  fingerprint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17

      - name: Restore keystore (with trimming)
        run: |
          # Remove trailing spaces and decode keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d ' \n' | base64 --decode > upload-keystore.jks
          
          # Verify the file was created
          if [ -f upload-keystore.jks ]; then
            echo "‚úÖ Keystore file created successfully"
            ls -lh upload-keystore.jks
          else
            echo "‚ùå Failed to create keystore file"
            exit 1
          fi

      - name: Extract SHA-1 fingerprint
        env:
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          echo "=========================================="
          echo "üîë Extracting SHA-1 fingerprint..."
          echo "=========================================="
          echo ""
          echo "Key Alias: $KEY_ALIAS"
          echo ""
          
          # List all entries in keystore
          echo "üìã All keystore entries:"
          keytool -list -keystore upload-keystore.jks -storepass "$STORE_PASSWORD" || true
          echo ""
          echo "=========================================="
          echo ""
          
          # Extract detailed info for the specific alias
          echo "üîç Detailed certificate info for alias '$KEY_ALIAS':"
          keytool -list -v -keystore upload-keystore.jks -alias "$KEY_ALIAS" -storepass "$STORE_PASSWORD" | grep -A 5 "Certificate fingerprints"
          echo ""
          echo "=========================================="
          echo ""
          
          # Extract just the SHA-1
          SHA1=$(keytool -list -v -keystore upload-keystore.jks -alias "$KEY_ALIAS" -storepass "$STORE_PASSWORD" | grep "SHA1:" | cut -d':' -f2- | tr -d ' ')
          
          if [ -n "$SHA1" ]; then
            echo "‚úÖ SHA-1 Fingerprint found:"
            echo ""
            echo "    $SHA1"
            echo ""
            echo "=========================================="
            echo "üìù Add this to Google Cloud Console:"
            echo "=========================================="
            echo "Package name: tech.routemate.app"
            echo "SHA-1: $SHA1"
          else
            echo "‚ùå Could not extract SHA-1 fingerprint"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f upload-keystore.jks
          echo "üßπ Cleaned up keystore file"